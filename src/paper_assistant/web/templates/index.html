{% extends "base.html" %}

{% block title %}Papers — Paper Assistant{% endblock %}

{% block content %}
<h1>Papers</h1>

<!-- Add paper form -->
<details>
    <summary>Add a new paper</summary>
    <form id="add-form">
        <input type="url" name="url" placeholder="https://arxiv.org/abs/2503.10291" required>
        <input type="text" name="tags" placeholder="Tags (comma-separated, e.g. multimodal, rl)">
        <button type="submit">Add Paper</button>
    </form>
    <div id="add-status"></div>
</details>

<!-- Import pre-generated summary -->
<details>
    <summary>Import a pre-generated summary</summary>
    <form id="import-form">
        <label for="import-url">arXiv URL</label>
        <input type="url" id="import-url" name="url" placeholder="https://arxiv.org/abs/2503.10291" required>
        <label for="import-tags">Tags</label>
        <input type="text" id="import-tags" name="tags" placeholder="Tags (comma-separated, e.g. multimodal, rl)">
        <label for="import-markdown">Markdown summary</label>
        <textarea id="import-markdown" name="markdown" rows="12" placeholder="Paste your markdown summary here..." required></textarea>
        <button type="submit">Import Summary</button>
    </form>
    <div id="import-status"></div>
</details>

<!-- Notion sync controls -->
<details>
    <summary>Sync with Notion</summary>
    <form id="notion-sync-form">
        <label for="notion-sync-paper">Paper filter (optional)</label>
        <input type="text" id="notion-sync-paper" name="paper" placeholder="arXiv ID or Notion page ID">
        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
            <button type="button" onclick="runNotionSync(true)">Preview Sync</button>
            <button type="button" onclick="runNotionSync(false)">Run Sync</button>
        </div>
    </form>
    <div id="notion-sync-status"></div>
</details>

{# Build a base query string that preserves all active filters/sort for link generation #}
{% macro filter_url(param, value, exclude_param=None) %}
{%- set parts = [] -%}
{%- if param != "tag" and active_tag %}{% set _ = parts.append("tag=" + active_tag) %}{% endif -%}
{%- if param != "status" and active_status %}{% set _ = parts.append("status=" + active_status) %}{% endif -%}
{%- if param != "reading_status" and active_reading_status %}{% set _ = parts.append("reading_status=" + active_reading_status) %}{% endif -%}
{%- if param != "sort" and active_sort != "date_added" %}{% set _ = parts.append("sort=" + active_sort) %}{% endif -%}
{%- if param != "order" and active_order != "desc" %}{% set _ = parts.append("order=" + active_order) %}{% endif -%}
{%- if value %}{% set _ = parts.append(param + "=" + value) %}{% endif -%}
/{% if parts %}?{{ parts | join("&") }}{% endif %}
{%- endmacro %}

<!-- Tag filter -->
{% if all_tags %}
<p>
    <strong>Filter by tag:</strong>
    <a href="{{ filter_url('tag', '') }}" {% if not active_tag %}class="contrast"{% endif %}>All</a>
    {% for tag in all_tags %}
    &middot; <a href="{{ filter_url('tag', tag) }}" {% if active_tag == tag %}class="contrast"{% endif %}>{{ tag }}</a>
    {% endfor %}
</p>
{% endif %}

<!-- Processing status filter -->
<p>
    <strong>Status:</strong>
    <a href="{{ filter_url('status', '') }}" {% if not active_status %}class="contrast"{% endif %}>All</a>
    {% for s in all_statuses %}
    &middot; <a href="{{ filter_url('status', s) }}" {% if active_status == s %}class="contrast"{% endif %}>{{ s }}</a>
    {% endfor %}
</p>

<!-- Reading status filter -->
<p>
    <strong>Reading:</strong>
    <a href="{{ filter_url('reading_status', '') }}" {% if not active_reading_status %}class="contrast"{% endif %}>All</a>
    {% for rs in all_reading_statuses %}
    &middot; <a href="{{ filter_url('reading_status', rs) }}" {% if active_reading_status == rs %}class="contrast"{% endif %}>{{ rs | capitalize }}</a>
    {% endfor %}
</p>

<!-- Sort controls -->
{% if papers or active_sort != "date_added" %}
<p>
    <strong>Sort by:</strong>
    {% for s, label, default_ord in [("date_added", "Date Added", "desc"), ("title", "Title", "asc"), ("tag", "Tag", "asc"), ("arxiv_id", "arXiv ID", "asc")] %}
    {% if s == active_sort %}
        {% set next_ord = "asc" if active_order == "desc" else "desc" %}
        {# Build sort URL preserving all filters #}
        {% set sort_url = filter_url('sort', s) %}
        {% if "order=" not in sort_url %}
            {% set sort_url = sort_url + ("&" if "?" in sort_url else "?") + "order=" + next_ord %}
        {% endif %}
        <a href="{{ filter_url('sort', s + '&order=' + next_ord) }}" class="contrast">{{ label }} {{ "▼" if active_order == "desc" else "▲" }}</a>
    {% else %}
        <a href="{{ filter_url('sort', s + '&order=' + default_ord) }}">{{ label }}</a>
    {% endif %}
    {% if not loop.last %} &middot; {% endif %}
    {% endfor %}
</p>
{% endif %}

<!-- Paper list -->
{% if papers %}
<p><small>{{ total }} paper{{ 's' if total != 1 else '' }}</small></p>
<table>
    <thead>
        <tr>
            <th>arXiv ID</th>
            <th>Title</th>
            <th>Tags</th>
            <th>Added</th>
            <th>Status</th>
            <th>Reading</th>
            <th>Audio</th>
            <th></th>
        </tr>
    </thead>
    <tbody>
        {% for p in papers %}
        <tr id="row-{{ p.metadata.arxiv_id }}">
            <td><a href="/paper/{{ p.metadata.arxiv_id }}">{{ p.metadata.arxiv_id }}</a></td>
            <td><a href="/paper/{{ p.metadata.arxiv_id }}">{{ p.metadata.title[:60] }}{{ '...' if p.metadata.title|length > 60 else '' }}</a></td>
            <td>{{ p.tags | join(', ') }}</td>
            <td>{{ p.date_added.strftime('%Y-%m-%d') }}</td>
            <td>{{ p.status.value }}</td>
            <td>
                <select class="reading-status-select" data-arxiv-id="{{ p.metadata.arxiv_id }}"
                        onchange="updateReadingStatus(this)">
                    {% for rs in ["unread", "read", "archived"] %}
                    <option value="{{ rs }}" {% if p.reading_status.value == rs %}selected{% endif %}>{{ rs | capitalize }}</option>
                    {% endfor %}
                </select>
            </td>
            <td>
                {% if p.audio_path %}
                <a href="/audio/{{ p.metadata.arxiv_id }}.mp3">Play</a>
                {% else %}
                —
                {% endif %}
            </td>
            <td><a href="#" onclick="deletePaper('{{ p.metadata.arxiv_id }}'); return false;" style="color: var(--pico-color-red-500, #dc3545); font-size: 0.8rem;">Delete</a></td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% else %}
<p>No papers yet. Add one using the form above or the CLI:</p>
<pre><code>paper-assist add https://arxiv.org/abs/2503.10291</code></pre>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
function parseTags(str) {
    return str ? str.split(',').map(t => t.trim()).filter(Boolean) : [];
}

document.getElementById('add-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const form = e.target;
    const url = form.url.value;
    const tags = parseTags(form.tags.value);
    const status = document.getElementById('add-status');

    status.innerHTML = '<p aria-busy="true">Processing paper... This may take a minute.</p>';
    form.querySelector('button[type="submit"]').disabled = true;

    try {
        const params = new URLSearchParams({url, skip_audio: 'false'});
        tags.forEach(t => params.append('tags', t));
        const resp = await fetch(`/api/add?${params}`, { method: 'POST' });
        const data = await resp.json();
        if (!resp.ok || data.error) {
            const detail = data.detail ? data.detail.map(d => d.msg).join(', ') : '';
            status.innerHTML = `<p class="error">${data.error || detail || 'Server error'}</p>`;
        } else {
            status.innerHTML = `<p>Added: <a href="/paper/${data.arxiv_id}">${data.title}</a></p>`;
            setTimeout(() => location.reload(), 1000);
        }
    } catch (err) {
        status.innerHTML = `<p class="error">Error: ${err.message}</p>`;
    } finally {
        form.querySelector('button[type="submit"]').disabled = false;
    }
});

document.getElementById('import-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const form = e.target;
    const url = document.getElementById('import-url').value;
    const tags = parseTags(document.getElementById('import-tags').value);
    const markdown = document.getElementById('import-markdown').value;
    const status = document.getElementById('import-status');

    status.innerHTML = '<p aria-busy="true">Importing summary and generating audio...</p>';
    form.querySelector('button[type="submit"]').disabled = true;

    try {
        const resp = await fetch('/api/import', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({url, markdown, tags}),
        });
        const data = await resp.json();
        if (!resp.ok || data.error) {
            const detail = data.detail ? data.detail.map(d => d.msg).join(', ') : '';
            const errMsg = data.error || detail || `Server error (${resp.status})`;
            status.innerHTML = `<p class="error">${errMsg}</p>`;
        } else {
            status.innerHTML = `<p>Imported: <a href="/paper/${data.arxiv_id}">${data.title}</a></p>`;
            setTimeout(() => location.reload(), 1000);
        }
    } catch (err) {
        status.innerHTML = `<p class="error">Error: ${err.message}</p>`;
    } finally {
        form.querySelector('button[type="submit"]').disabled = false;
    }
});

async function deletePaper(arxivId) {
    if (!confirm(`Delete paper ${arxivId} and all its files?`)) return;
    const resp = await fetch(`/api/paper/${arxivId}`, { method: 'DELETE' });
    const data = await resp.json();
    if (data.status === 'ok') {
        document.getElementById(`row-${arxivId}`)?.remove();
    } else {
        alert(data.error || 'Failed to delete paper');
    }
}

async function updateReadingStatus(select) {
    const arxivId = select.dataset.arxivId;
    const resp = await fetch(`/api/paper/${arxivId}/reading-status`, {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({reading_status: select.value}),
    });
    const data = await resp.json();
    if (data.error) {
        alert(data.error);
        location.reload();
    }
}

async function runNotionSync(dryRun) {
    const paper = document.getElementById('notion-sync-paper')?.value?.trim();
    const status = document.getElementById('notion-sync-status');
    const mode = dryRun ? 'preview' : 'sync';
    status.innerHTML = `<p aria-busy="true">Running Notion ${mode}...</p>`;

    try {
        let resp;
        if (dryRun) {
            const query = paper ? `?paper=${encodeURIComponent(paper)}` : '';
            resp = await fetch(`/api/notion/sync/preview${query}`);
        } else {
            resp = await fetch('/api/notion/sync', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({paper_id: paper || null, dry_run: false}),
            });
        }
        const data = await resp.json();
        if (data.error) {
            status.innerHTML = `<p class="error">${data.error}</p>`;
            return;
        }
        const report = data.report || {};
        status.innerHTML = `
            <p>
                Local created: ${report.local_created ?? 0}, updated: ${report.local_updated ?? 0}, archived: ${report.local_archived ?? 0}<br>
                Notion created: ${report.notion_created ?? 0}, updated: ${report.notion_updated ?? 0}, archived: ${report.notion_archived ?? 0}<br>
                Skipped: ${report.skipped ?? 0}
            </p>
            ${(report.warnings && report.warnings.length) ? `<p><strong>Warnings:</strong> ${report.warnings.join(' | ')}</p>` : ''}
            ${(report.errors && report.errors.length) ? `<p class="error"><strong>Errors:</strong> ${report.errors.join(' | ')}</p>` : ''}
        `;
        if (!dryRun) {
            setTimeout(() => location.reload(), 1200);
        }
    } catch (err) {
        status.innerHTML = `<p class="error">Error: ${err.message}</p>`;
    }
}
</script>
{% endblock %}
